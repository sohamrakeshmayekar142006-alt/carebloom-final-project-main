<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - CareBloom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background: linear-gradient(135deg, #fde2e4, #fbcfe8, #fff0f5);
      }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen">
    <div class="bg-white shadow-lg rounded-2xl w-full max-w-md p-8">
      <div class="text-center mb-6">
        <h1 class="text-2xl font-bold mb-2 text-pink-600">🌱 CareBloom</h1>
        <h2 class="text-2xl font-bold mb-4 text-pink-600">Welcome Back</h2>
        <p class="text-gray-500 mb-6">Please sign in to continue</p>
      </div>

      <form id="login-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Email *</label>
          <input
            id="email"
            type="email"
            class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-pink-200"
            placeholder="Enter your email"
            required
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Password *</label>
          <input
            id="password"
            type="password"
            class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-pink-200"
            placeholder="Enter your password"
            required
          />
        </div>
        <button
          type="submit"
          class="w-full bg-pink-500 text-white py-2 rounded-md font-semibold hover:bg-pink-600 transition"
        >
          Sign In
        </button>
      </form>

      <div class="mt-6 text-center">
        <p class="text-sm text-gray-500">
          Don't have an account?
          <a href="/donororngo" class="font-semibold text-pink-600 hover:underline">
            Create one
          </a>
        </p>
      </div>

      <div class="mt-4 text-center">
        <p class="text-xs text-gray-400">
          By continuing, you agree to our 
          <a href="#" class="text-pink-500 hover:underline">Terms of Service</a> 
          and 
          <a href="#" class="text-pink-500 hover:underline">Privacy Policy</a>
        </p>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./auth.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('✅ Login page loaded');
        
        // Check if user is already logged in
        try {
          const session = await window.authHelper.checkAuth();
          if (session) {
            console.log('🔍 User already logged in, checking profile type...');
            
            // Check if donor or NGO
            const { data: donorProfile } = await window.authHelper.supabase
              .from('donor_profiles')
              .select('id')
              .eq('id', session.user.id)
              .single();
              
            if (donorProfile) {
              console.log('🎯 Redirecting to donor dashboard');
              window.location.href = 'dashboard.html';
              return;
            }

            // Check if NGO
            const { data: ngoProfile } = await window.authHelper.supabase
              .from('ngo_profiles')
              .select('id')
              .eq('id', session.user.id)
              .single();

            if (ngoProfile) {
              console.log('🏢 Redirecting to NGO dashboard');
              window.location.href = 'ngodashboard.html';
              return;
            }

            console.log('❓ User has no profile, staying on login page');
          }
        } catch (error) {
          console.warn('⚠️ Auth check failed:', error);
        }
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          console.log('🔄 Login form submitted');
          
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          
          submitBtn.disabled = true;
          submitBtn.textContent = 'Signing In...';
          
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          
          try {
            await window.authHelper.loginUser(email, password);
          } catch (error) {
            console.error('💥 Login failed:', error);
            alert('Login failed: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      });
    </script>
  </body>
</html>