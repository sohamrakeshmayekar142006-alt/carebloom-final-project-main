<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - NGO Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6">NGO Verification Panel</h1>
        
        <div id="pending-ngos" class="space-y-4">
            <h2 class="text-2xl font-semibold mb-4">Pending NGOs</h2>
            <!-- NGOs will be loaded here -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://ceorbsqwabgioxfcrqvv.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlb3Jic3F3YWJnaW94ZmNycXZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDQ3OTMsImV4cCI6MjA3NDkyMDc5M30.rcmIGUIg1jeTXu0n6lc5Kpz3BLwmIzm2aOW4V6alOlU";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function loadPendingNGOs() {
            const { data: ngos, error } = await supabase
                .from('ngo_profiles')
                .select('*')
                .eq('status', 'pending')
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error loading NGOs:', error);
                return;
            }

            const container = document.getElementById('pending-ngos');
            
            if (ngos.length === 0) {
                container.innerHTML += '<p class="text-gray-500">No pending NGOs</p>';
                return;
            }

            ngos.forEach(ngo => {
                const ngoCard = `
                    <div class="bg-white p-6 rounded-lg shadow-md border">
                        <h3 class="text-xl font-bold">${ngo.ngo_name}</h3>
                        <p><strong>Email:</strong> ${ngo.contact_email}</p>
                        <p><strong>Phone:</strong> ${ngo.contact_phone}</p>
                        <p><strong>Address:</strong> ${ngo.address}, ${ngo.city}, ${ngo.state} - ${ngo.pin_code}</p>
                        <p><strong>Registration No:</strong> ${ngo.registration_number}</p>
                        <p><strong>Darpan ID:</strong> ${ngo.darpan_id}</p>
                        <p><strong>Registered:</strong> ${new Date(ngo.created_at).toLocaleDateString()}</p>
                        
                        <div class="mt-4 flex gap-4">
                            <button onclick="approveNGO('${ngo.id}')" 
                                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Approve
                            </button>
                            <button onclick="showRejectForm('${ngo.id}')" 
                                    class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                Reject
                            </button>
                            <button onclick="viewDocuments('${ngo.id}')" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                View Documents
                            </button>
                        </div>
                        
                        <div id="reject-form-${ngo.id}" class="hidden mt-4">
                            <textarea id="reject-reason-${ngo.id}" 
                                      placeholder="Reason for rejection..." 
                                      class="w-full p-2 border rounded"></textarea>
                            <button onclick="rejectNGO('${ngo.id}')" 
                                    class="bg-red-600 text-white px-4 py-2 rounded mt-2">
                                Confirm Rejection
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += ngoCard;
            });
        }

        async function approveNGO(ngoId) {
            if (!confirm('Are you sure you want to approve this NGO?')) return;

            const { error } = await supabase
                .from('ngo_profiles')
                .update({ 
                    status: 'approved',
                    verified_at: new Date().toISOString()
                })
                .eq('id', ngoId);

            if (error) {
                alert('Error approving NGO: ' + error.message);
            } else {
                alert('NGO approved successfully!');
                location.reload();
            }
        }

        function showRejectForm(ngoId) {
            document.getElementById(`reject-form-${ngoId}`).classList.toggle('hidden');
        }

        async function rejectNGO(ngoId) {
            const reason = document.getElementById(`reject-reason-${ngoId}`).value;
            if (!reason) {
                alert('Please provide a reason for rejection');
                return;
            }

            const { error } = await supabase
                .from('ngo_profiles')
                .update({ 
                    status: 'rejected',
                    verification_notes: reason,
                    verified_at: new Date().toISOString()
                })
                .eq('id', ngoId);

            if (error) {
                alert('Error rejecting NGO: ' + error.message);
            } else {
                alert('NGO rejected successfully!');
                location.reload();
            }
        }

      async function viewDocuments(ngoId) {
    try {
        // Get document records from database
        const { data: documents, error } = await supabase
            .from('ngo_verification_docs')
            .select('*')
            .eq('ngo_id', ngoId);

        if (error) {
            alert('Error loading documents: ' + error.message);
            return;
        }

        if (documents.length === 0) {
            alert('No documents found for this NGO');
            return;
        }

        // Create a modal to display documents
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">NGO Verification Documents</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            class="text-gray-500 hover:text-gray-700 text-2xl">
                        Ã—
                    </button>
                </div>
                <div class="space-y-4" id="documents-container">
                    ${documents.map(doc => `
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold capitalize">${doc.document_type.replace('_', ' ')}</h4>
                            <p class="text-sm text-gray-600">File: ${doc.file_name}</p>
                            <div class="mt-2">
                                <button onclick="downloadDocument('${doc.file_path}', '${doc.file_name}')"
                                        class="bg-blue-500 text-white px-3 py-1 rounded text-sm mr-2">
                                    Download
                                </button>
                                <button onclick="viewDocument('${doc.file_path}')"
                                        class="bg-green-500 text-white px-3 py-1 rounded text-sm">
                                    View
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        document.body.appendChild(modal);

    } catch (error) {
        console.error('Error viewing documents:', error);
        alert('Error loading documents');
    }
}

// Function to download documents
async function downloadDocument(filePath, fileName) {
    try {
        const { data, error } = await supabase.storage
            .from('verification-docs')
            .download(filePath);

        if (error) {
            alert('Error downloading file: ' + error.message);
            return;
        }

        // Create download link
        const url = URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

    } catch (error) {
        console.error('Download error:', error);
        alert('Error downloading document');
    }
}

// Function to view documents in new tab
async function viewDocument(filePath) {
    try {
        const { data, error } = await supabase.storage
            .from('verification-docs')
            .createSignedUrl(filePath, 60 * 5); // 5 minutes expiry

        if (error) {
            alert('Error generating view link: ' + error.message);
            return;
        }

        // Open in new tab
        window.open(data.signedUrl, '_blank');

    } catch (error) {
        console.error('View document error:', error);
        alert('Error viewing document');
    }
}
        // Load pending NGOs when page loads
        loadPendingNGOs();
    </script>
</body>
</html>